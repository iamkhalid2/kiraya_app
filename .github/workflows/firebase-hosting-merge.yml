# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
'on':
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
      
      # Generate minimal firebase.json for hosting
      - name: Create Firebase config
        run: |
          cat > firebase.json << 'EOL'
          {
            "hosting": {
              "public": "build/web",
              "ignore": [
                "firebase.json",
                "**/.*",
                "**/node_modules/**"
              ],
              "rewrites": [
                {
                  "source": "**",
                  "destination": "/index.html"
                }
              ]
            }
          }
          EOL
      
      # Remove existing firebase_options.dart if it exists
      - name: Remove existing firebase_options.dart
        run: rm -f lib/firebase_options.dart
      
      # Generate firebase_options.dart
      - name: Generate Firebase Options
        run: |
          mkdir -p lib
          cat > lib/firebase_options.dart << 'EOL'
          // File generated by FlutterFire CLI.
          // ignore_for_file: type=lint
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show kIsWeb;

          /// Default [FirebaseOptions] for use with your Firebase apps.
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (!kIsWeb) {
                throw UnsupportedError(
                  'DefaultFirebaseOptions are only supported for web platform.',
                );
              }
              return web;
            }
            
            static const FirebaseOptions web = FirebaseOptions(
              apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}',
              appId: '${{ secrets.FIREBASE_WEB_APP_ID }}',
              messagingSenderId: '${{ secrets.FIREBASE_WEB_MESSAGING_SENDER_ID }}',
              projectId: '${{ secrets.FIREBASE_WEB_PROJECT_ID }}',
              authDomain: '${{ secrets.FIREBASE_WEB_AUTH_DOMAIN }}',
              storageBucket: '${{ secrets.FIREBASE_WEB_STORAGE_BUCKET }}',
              measurementId: '${{ secrets.FIREBASE_WEB_MEASUREMENT_ID }}',
            );
          }
          EOL

      # Verify firebase_options.dart content
      - name: Verify Firebase Options
        run: cat lib/firebase_options.dart

      # Get dependencies
      - name: Get dependencies
        run: flutter pub get

      # Build web
      - name: Build web
        run: flutter build web --release
      
      # Deploy to Firebase
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KIRAYA_8948A }}
          channelId: live
          projectId: kiraya-8948a